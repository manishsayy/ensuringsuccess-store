<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Educational Cart â€“ Ensuring Success</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h2 class="text-primary mb-4 fw-bold">Welcome to the Educational Cart</h2>
    <div id="product-container" class="row gy-4"></div>

    <div class="card mt-5 shadow-sm" style="max-width: 700px;">
      <div class="card-body">
        <h5 class="card-title">
          ðŸ›’ Cart Preview
        </h5>
        <div id="cart-items" class="mb-3"></div>
        <hr>
        <p><strong>Total Cart Value:</strong> â‚¹<span id="cart-total">0</span></p>
        <div class="mb-3">
          <label for="userEmail" class="form-label">Enter your email</label>
          <input type="email" class="form-control" id="userEmail" placeholder="you@example.com" required>
        </div>
        <button class="btn btn-success" onclick="proceedToCheckout()">Proceed to Checkout</button>
      </div>
    </div>
  </div>

  <script>
    const endpoint = "https://script.google.com/macros/s/AKfycbyNyZz3eBtC12jhj4PHUO_LC7uXlEQzE7qYAS2XrLyRXwUkxxgyK0EQe-sN1R0Jcd5z/exec";
    const cart = [];

    function renderProducts(products) {
      const container = document.getElementById("product-container");
      container.innerHTML = "";

      products.forEach(product => {
        if (product.Type === "educational" && product.Active === "Y") {
          const col = document.createElement("div");
          col.className = "col-md-4";
          const card = document.createElement("div");
          card.className = "card h-100";

          // Handle image only if valid
          let imageTag = "";
          if (product["Image URL"] && product["Image URL"].startsWith("http")) {
            imageTag = `<img src="${product["Image URL"]}" class="card-img-top" alt="${product.Name}" onerror="this.style.display='none'">`;
          }

          card.innerHTML = `
            ${imageTag}
            <div class="card-body d-flex flex-column">
              <h5 class="card-title">${product.Name}</h5>
              <p class="card-text fw-semibold text-dark">â‚¹${product.Price}</p>
              <p class="card-text small text-muted">${product.Description}</p>
              <button class="btn btn-primary mt-auto" onclick='addToCart(${JSON.stringify(product)})'>Add to Cart</button>
            </div>
          `;
          col.appendChild(card);
          container.appendChild(col);
        }
      });
    }

    function addToCart(product) {
      cart.push({
        id: product.ID,
        name: product.Name,
        price: Number(product.Price)
      });
      updateCartUI();
    }

    function updateCartUI() {
      const container = document.getElementById("cart-items");
      container.innerHTML = "";
      let total = 0;

      cart.forEach(item => {
        total += item.price;
        const p = document.createElement("p");
        p.textContent = `${item.name} â€“ â‚¹${item.price}`;
        container.appendChild(p);
      });

      document.getElementById("cart-total").textContent = total;
    }

    function proceedToCheckout() {
      const email = document.getElementById("userEmail").value.trim();
      if (!validateEmail(email)) {
        alert("Please enter a valid email address.");
        return;
      }

      if (cart.length === 0) {
        alert("Cart is empty!");
        return;
      }

      const refId = generateRefId();
      const total = cart.reduce((sum, item) => sum + item.price, 0);
      const payload = {
        email,
        refId,
        total,
        items: cart
      };

      fetch(endpoint, {
        method: "POST",
        body: JSON.stringify(payload),
        headers: {
          "Content-Type": "application/json"
        }
      }).then(() => {
        // Silent success â€“ no popup
        // Phase 3: redirect or trigger payment will happen here
      }).catch(error => {
        alert("Checkout failed: " + error.message);
      });
    }

    function validateEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function generateRefId() {
      const now = new Date();
      const datePart = now.toISOString().slice(0,10).replace(/-/g, '');
      const randomPart = Math.floor(1000 + Math.random() * 9000);
      return `Ref${datePart}${randomPart}`;
    }

    // Initial fetch
    fetch(endpoint)
      .then(res => res.json())
      .then(data => renderProducts(data))
      .catch(err => {
        document.getElementById("product-container").innerHTML = "<p class='text-danger'>Failed to load products.</p>";
        console.error("Error fetching product data:", err);
      });
  </script>
</body>
</html>
