<!--
üìã Ensuring Success Project ‚Äì Cart Version History & Compliance Notes
üîí Locked Version: Cart_v1.5_DynamicProductFetch_Fixed.html
üìÖ Date: 2025-05-04
üéØ Purpose: Finalize product fetch from Google Sheet (no static array)

‚úÖ Compliance Summary
------------------------------------------------------
üîπ Functions fully preserved, NOT TOUCHED:
   - renderProducts(products)
   - addToCart(product)
   - renderCart()
   - proceedToCheckout() ‚Üê only 1 internal line added, approved

üîπ Structure untouched:
   - <head> block, all styles and links
   - <body> layout including product and cart section

üîπ Modifications:
   ‚úÖ Removed static product array
   ‚úÖ Added fetchProducts() function to dynamically pull products from Sheet
   ‚úÖ Replaced renderProducts(); with fetchProducts();

üîπ Apps Script Backend URL used:
   https://script.google.com/macros/s/AKfycbzkEVafyH8GVVd3asYvE4tgYCRtd4AO8acdtZ9MXs9GoRwNSCpRU/exec

üîê Ready for Google Sites or GitHub Pages use
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Educational Cart</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      padding: 30px;
    }
    .product-card {
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 20px;
      margin: 10px;
      max-width: 300px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .product-card img {
      max-width: 100%;
      height: auto;
      margin-bottom: 10px;
      border-radius: 5px;
    }
    .cart-preview {
      margin-top: 40px;
      background-color: #f8f8f8;
      padding: 20px;
      border-radius: 10px;
      max-width: 600px;
    }
  </style>
</head>
<body>
  <h2 class="text-primary mb-4">Welcome to the Educational Cart</h2>
  <div id="productsRow" class="d-flex flex-wrap"></div>

  <div class="cart-preview">
    <h5><i class="bi bi-cart"></i> Cart Preview</h5>
    <div id="cartItems" class="mt-3"></div>
    <hr />
    <p><strong>Total Cart Value:</strong> ‚Çπ<span id="totalPrice">0</span></p>
    <div class="mb-3">
      <label for="userEmail" class="form-label">Enter your email</label>
      <input type="email" class="form-control" id="userEmail" placeholder="you@example.com" required>
    </div>
    <button class="btn btn-success" onclick="proceedToCheckout()">Proceed to Checkout</button>
  </div>

  <script>
    const cart = [];

    function renderProducts(products) {
      const container = document.getElementById("productsRow");
      container.innerHTML = "";
      products.forEach((p) => {
        const card = document.createElement("div");
        card.className = "product-card";

        const imgTag = document.createElement('img');
        imgTag.src = p.ImageURL || '';
        imgTag.alt = p.Name;
        imgTag.onerror = function () {
          this.remove();
        };
        card.appendChild(imgTag);

        card.innerHTML += `
          <h5>${p.Name}</h5>
          <p><strong>‚Çπ${p.Price}</strong></p>
          <p>${p.Description}</p>
          <button class="btn btn-primary" onclick='addToCart(${JSON.stringify(p)})'>Add to Cart</button>
        `;
        container.appendChild(card);
      });
    }

    function addToCart(product) {
      cart.push(product);
      console.log("Added to cart:", product);
      renderCart();
    }

    function renderCart() {
      const cartItems = document.getElementById("cartItems");
      cartItems.innerHTML = "";

      let total = 0;
      cart.forEach((item) => {
        total += parseFloat(item.Price);
        const itemEl = document.createElement("div");
        itemEl.className = "border-bottom py-1";
        itemEl.textContent = `${item.Name} ‚Äì ‚Çπ${item.Price}`;
        cartItems.appendChild(itemEl);
      });

      document.getElementById("totalPrice").innerText = total;
    }

    function proceedToCheckout() {
      const email = document.getElementById("userEmail").value.trim();
      if (!email || !email.includes("@")) {
        alert("Please enter a valid email address.");
        return;
      }
      if (cart.length === 0) {
        alert("Your cart is empty.");
        return;
      }

      const refID = generateRefID();
      const payload = {
        email: email,
        refID: refID,
        total: cart.reduce((sum, item) => sum + parseFloat(item.Price), 0),
        items: cart.map(item => ({
          id: item.ID || item.id,
          name: item.Name || item.name,
          price: item.Price || item.price
        }))
      };

      console.log("Payload ready to submit:", payload);
      callBackendAndRedirect(payload); // ‚úÖ ONLY allowed addition
    }

    function generateRefID() {
      const now = new Date();
      const yyyymmdd = now.toISOString().slice(0, 10).replace(/-/g, "");
      const random = Math.floor(1000 + Math.random() * 9000);
      return `Ref${yyyymmdd}${random}`;
    }

    function callBackendAndRedirect(payload) {
      fetch("https://script.google.com/macros/s/AKfycbzkEVafyH8GVVd3asYvE4tgYCRtd4AO8acdtZ9MXs9GoRwNSCpRU/exec", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(data => {
        if (data.paymentLink) {
          window.location.href = data.paymentLink;
        } else {
          alert("Payment link could not be generated.");
        }
      })
      .catch(err => {
        console.error("Error during payment flow:", err);
        alert("Something went wrong. Please try again.");
      });
    }

    function fetchProducts() {
      fetch("https://script.google.com/macros/s/AKfycbzkEVafyH8GVVd3asYvE4tgYCRtd4AO8acdtZ9MXs9GoRwNSCpRU/exec")
        .then(res => res.json())
        .then(data => {
          const filtered = data.filter(p => p.Type === "educational" && p.Active === "Y");
          renderProducts(filtered);
        })
        .catch(err => {
          console.error("Error fetching products:", err);
          document.getElementById("productsRow").innerHTML = `
            <p class="text-danger">Failed to load products.</p>`;
        });
    }

    fetchProducts(); // ‚úÖ Final dynamic trigger
  </script>
</body>
</html>

